<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ben Davies">
<meta name="dcterms.date" content="2025-10-28">

<title>Putting the FUN in FUNdamentals of Programming</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="pRogramming_files/libs/clipboard/clipboard.min.js"></script>
<script src="pRogramming_files/libs/quarto-html/quarto.js"></script>
<script src="pRogramming_files/libs/quarto-html/popper.min.js"></script>
<script src="pRogramming_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pRogramming_files/libs/quarto-html/anchor.min.js"></script>
<link href="pRogramming_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pRogramming_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pRogramming_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pRogramming_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pRogramming_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Putting the FUN in FUNdamentals of Programming</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ben Davies </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Beyond manipulating and plotting data, R is a powerful tool for automating complicated tasks and making them easy to reproduce. This is often done through the use of programming customized algorithms and functions. In this section, we will work on a few of the most common types of programming structures.</p>
<section id="first-steps" class="level2">
<h2 class="anchored" data-anchor-id="first-steps">First steps</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="for-loops" class="level2">
<h2 class="anchored" data-anchor-id="for-loops"><code>for</code> loops</h2>
<p>A <code>for</code> loop is a structure that iterates over a vector and performs a task for each item. This is useful when you want to apply an elaborate procedure over a given set of data. First, create a new script/Quarto document and save it alongside the dataset here. Next, let’s load some data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fishlength<span class="ot">&lt;-</span><span class="fu">read_csv</span>(<span class="st">"fishlength.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>fishlength</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 249 × 2
   species          length_mm
   &lt;chr&gt;                &lt;dbl&gt;
 1 A. dieffenbachii      871.
 2 O. mykiss             378.
 3 O. mykiss             471.
 4 A. dieffenbachii      844.
 5 A. dieffenbachii      700.
 6 O. mykiss             446.
 7 O. mykiss             412.
 8 A. dieffenbachii      660.
 9 O. mykiss             276.
10 A. dieffenbachii      801.
# ℹ 239 more rows</code></pre>
</div>
</div>
<p>This is some made-up data on fish lengths from a 100m<sup>2</sup> stream survey for two species: longfin eels (<em>Anguilla dieffenbachii</em>) and rainbow trout (<em>Oncorhynchus mykiss</em>). A basic <code>for</code> loop could take the species information and incorporate it into a character string. We can do this by adding the following to the script:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  j<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">"The scientific name of this fish is"</span>, fishlength[i,<span class="dv">1</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(j)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"</code></pre>
</div>
</div>
<p>This shows how a basic for loop is constructed. After we use <code>for</code>, we put in our iterator in parentheses, which here is <code>(i in 1:10)</code>. Combined, this reads <code>for (i in 1:10)</code>, which basically means:</p>
<p><strong>For every item <em>i</em> in the integer sequence 1 to 10</strong></p>
<p>You might think of it like a line of people waiting to ride a rollercoaster, where the people are the sequence of integers, and the rollercoaster is the loop instructions. The rollercoaster car picks up one of the people waiting (in the first case, the number 1), takes them through the loop, returns to the beginning and then picks up the next person (in this case, 2). The letter <code>i</code> here acts like the rollercoaster car; each number in our sequence will be iterated through the loop code as <code>i</code>.<br>
<br>
The rest of the loop is in curly braces, and this is the code that will be applied using each item in the sequence from 1 to 10. The <code>paste</code> function will take a couple of character strings and paste them together to form a single string. Here, we are pasting together the phrase “The scientific name of this fish is” and <code>fishlength[i,1]</code>, which means the item at the <em>i</em>th row and the 1st column in our data table. Remembering that the <code>for</code> loop will iterate each value in the sequence of 1 to 10 into the placeholder variable <code>i</code>, and since the first column of the dataset is species names, then this code will iterate through each of the first ten entries in the species column and add them into the character string. The code saves this to a variable called j, and then prints this value before moving on to the next value in the sequence. The result is 10 repetitions of the same phrase, each being combined from the text and an iterated value in the table.</p>
<p>A question might arise from this bit of the exercise: why did we use the term <code>i</code>? Is that short for something? Is it an R-specific term? The answer is a resounding NO: we could replace <code>i</code> with pretty much anything. Behold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (maryPoppins <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  j<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">"The scientific name of this fish is"</span>, fishlength[maryPoppins,<span class="dv">1</span>])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(j)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"
[1] "The scientific name of this fish is O. mykiss"
[1] "The scientific name of this fish is A. dieffenbachii"</code></pre>
</div>
</div>
<p>While i is sort of a convention in the programming world for loop iterators, this works like any other object name assignment we’ve seen so far. This is particularly important to know when you start building <a href="https://www.w3schools.com/r/r_for_loop_nested.asp">nested loops</a>, or loops within loops.</p>
<p>But what about the object’s value itself: can we use this in our loop? The answer here is a resounding YES, and this is one of the things that makes loops especially valuable. Have a look at this revised version of our loop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  j<span class="ot">&lt;-</span><span class="fu">paste</span>(<span class="st">"The scientific name of fish"</span>, i, <span class="st">"is"</span>, fishlength[i,<span class="dv">1</span>])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(j)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "The scientific name of fish 1 is A. dieffenbachii"
[1] "The scientific name of fish 2 is O. mykiss"
[1] "The scientific name of fish 3 is O. mykiss"
[1] "The scientific name of fish 4 is A. dieffenbachii"
[1] "The scientific name of fish 5 is A. dieffenbachii"
[1] "The scientific name of fish 6 is O. mykiss"
[1] "The scientific name of fish 7 is O. mykiss"
[1] "The scientific name of fish 8 is A. dieffenbachii"
[1] "The scientific name of fish 9 is O. mykiss"
[1] "The scientific name of fish 10 is A. dieffenbachii"</code></pre>
</div>
</div>
<p>Hopefully, this makes the process of loop iteration more clear. What’s happening here is that the text being pasted together includes a break after the word “fish”, which is followed by <code>i</code>. The <code>paste</code> function will take these and concatenate them, and as the loop progresses, it will go through each number in the list and use it in the generation of the printed phrase.<br>
<br>
Impressive, no? OK, this by itself is admittedly not very useful, but when combined with other programming elements, we can do quite a bit more.</p>
</section>
<section id="if-and-else-statements" class="level2">
<h2 class="anchored" data-anchor-id="if-and-else-statements"><code>if</code> and <code>else</code> statements</h2>
<p>An <code>if</code> statement will check to see whether a particular condition has been met and, if it has, it will perform a given task. In R, these follow the following pattern:</p>
<p><code>if (</code> <em>condition</em> <code>){</code> <em>task</em> <code>}</code></p>
<p>While we can apply operations and built-in functions to our data, sometimes we may want to apply these differently based on some criteria. This is where <code>if</code> statements are particularly useful.</p>
<p>Coming back to our fish length data, let’s say we wanted to estimate biomass in our pretend catchment. There are formulas that can be applied to length data to estimate sh weight, but these are usually specic to a given species<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. For the species in our data, these are:</p>
<p>Longn eel: <span class="math inline">\(W= 3.624 \times 10^{-7}  \times L^{3.307}\)</span></p>
<p>Rainbow trout: <span class="math inline">\(W = 2.101 \times 10^{-5}  \times L^{2.909}\)</span></p>
<p>Since we know these formulas, we can use an if statement to apply the correct formula to each species. There’s a few different ways this could be done, but we’ll walk through one way that uses an <code>if</code> statement.</p>
<p>First, let’s create an empty vector where we can store our new weight values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>weight<span class="ot">&lt;-</span><span class="fu">c</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need something that can go through each row in the table, so a <code>for</code> loop should do the job. For each row, we want to figure out whether that species is an eel and, if it is, we want to apply the right formula using the length. We can use an <code>if</code> statement to get this done. All in all the code going into our script will look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(fishlength)) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fishlength[i,<span class="dv">1</span>] <span class="sc">==</span> <span class="st">"A. dieffenbachii"</span>) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    l<span class="ot">&lt;-</span>fishlength[i,<span class="dv">2</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    w<span class="ot">&lt;-</span>(<span class="fl">3.624</span><span class="sc">*</span><span class="dv">10</span><span class="sc">^-</span><span class="dv">7</span>)<span class="sc">*</span>l<span class="sc">^</span><span class="fl">3.307</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    weight<span class="ot">&lt;-</span><span class="fu">append</span>(weight,<span class="fu">as.numeric</span>(w))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This begins as a <code>for</code> loop that iterates through a sequence of numbers: 1 through the number of of rows (<code>nrow</code>) in our <strong>fishlength</strong> tibble.</p>
<p>Next, we see the statement <code>if (fishlength[i,1] == "A. dieffenbachii")</code>. The code <code>fishlength[i,1]</code> is drawing again on the <em>i</em> placeholder variable from the <code>for</code> loop, so <code>[i,1]</code> reads as “the <em>i</em>the value of the 1st column.” This will iterate through each item in the species column and feed it into the value for <em>i</em>. The <code>==</code> compares these values to the character string “A. dieffenbachii”, the latin name for longn eel. If they are not the same, then the code returns back to the <code>for</code> loop and continues to the next row; otherwise, the <code>if</code> statement proceeds with the rest of the code.</p>
<p>The three lines inside of the if statement produce the weight values we’re looking for. First, it assigns the <em>ith</em> value from the <strong>length_mm</strong> column to the variable <code>len</code>. It plugs this value into the formula <code>(3.624*10^-7)*len^3.307</code>, which is the regression formula for weight in longn eels. This is assigned to the variable <code>w</code>. Finally, we use the <code>append</code> function to add this to our empty vector <code>weight</code>. Note that we use <code>as.numeric</code> to coerce the <code>w</code> object into a number (rather than as a 1x1 tibble).</p>
<p>As it proceeds through the table, for each eel it comes across, it will calculate the weight in grams and add it to the <code>weight</code> vector. We can then see these values stored in this vector using the <code>head</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1909.9337 1721.7956  927.3387  763.1644 1450.6099 4231.1627</code></pre>
</div>
</div>
<p>This is a good start, but ideally we want to calculate the weights for both species. How do we do this? Before continuing, try and think of a way this might be done.</p>
<p>First, let’s reset our weight vector to be empty:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>weight<span class="ot">&lt;-</span><span class="fu">c</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate the values for two species, you might consider adding another if statement below the first one, modifying the condition to include the scientific name for rainbow trout and substituting in the formula for that species. But since the only other species we are dealing with is trout, we can use <code>else</code> to simplify things a bit. The full code should look something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(fishlength)) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fishlength[i,<span class="dv">1</span>] <span class="sc">==</span> <span class="st">"A. dieffenbachii"</span>) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    l<span class="ot">&lt;-</span>fishlength[i,<span class="dv">2</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    w<span class="ot">&lt;-</span>(<span class="fl">3.624</span><span class="sc">*</span><span class="dv">10</span><span class="sc">^-</span><span class="dv">7</span>)<span class="sc">*</span>l<span class="sc">^</span><span class="fl">3.307</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    weight<span class="ot">&lt;-</span><span class="fu">append</span>(weight,<span class="fu">as.numeric</span>(w))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    l<span class="ot">&lt;-</span>fishlength[i,<span class="dv">2</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    w<span class="ot">&lt;-</span>(<span class="fl">2.101</span><span class="sc">*</span><span class="dv">10</span><span class="sc">^-</span><span class="dv">5</span>)<span class="sc">*</span>l<span class="sc">^</span><span class="fl">2.909</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    weight<span class="ot">&lt;-</span><span class="fu">append</span>(weight,<span class="fu">as.numeric</span>(w))</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the end, both of these solution do the same thing; however, not all cases will work this way, as we will see below. Now we can add our weight vector to our fish dataset and calculate biomass estimates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fishdata<span class="ot">&lt;-</span><span class="fu">mutate</span>(fishlength,<span class="at">weight=</span>weight)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>biomass<span class="ot">&lt;-</span><span class="fu">sum</span>(fishdata<span class="sc">$</span>weight)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>biomass</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 380907.6</code></pre>
</div>
</div>
<p>So, at least as far as eels and trout go, you can expect about 381 kgs/100m<sup>2</sup> from our pretend catchment.</p>
</section>
<section id="functions" class="level2">
<h2 class="anchored" data-anchor-id="functions">Functions</h2>
<p>After awhile, the code we generate may become cumbersome to understand if we need to repeatedly build nested for loops and if statements. In these cases, we may want to build functions that can perform some transformation on a value, or vector, or table of data. Defining functions in R is done through something along the lines of:</p>
<p><code>myfunction&lt;-function(</code> a , b ) <code>{</code> some code using a and b <code>}</code></p>
<p>For our first function, we’ll keep it simple: we have a water temperature recorded in degrees Fahrenheit that we would like to convert to degrees Celsius. What we want is a function that will take a value in one scale and do the mathematics to convert it to the other. Let’s call our new function <code>f2c</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>f2c<span class="ot">&lt;-</span><span class="cf">function</span>(f){</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  c<span class="ot">&lt;-</span>((f<span class="sc">+</span><span class="dv">40</span>)<span class="sc">/</span><span class="fl">1.8</span>)<span class="sc">-</span><span class="dv">40</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  c</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we begin by giving the function the name <code>f2c</code>. Next, we declare that it will be a function that accepts a variable value we call <code>f</code>. We don’t need to tell the function what the value of <code>f</code> will be, or even what kind of object it will be, as long as the remaining code can deal with the object we give it. Next, we declare that a new variable called <code>c</code> will be the outcome of a mathematical formula that includes the variable <code>f</code>. Finally, our function returns the value of the new variable <code>c</code>, and this will be the output of the function.</p>
<p>Once the function is loaded into R’s memory by running the code above, this will send all of the code to the R console and, presuming there are no errors in our code, it will now be a function we can call, just like functions we’ve already seen like <code>append</code> or <code>sum</code>. So let’s try it out!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f2c</span>(<span class="dv">68</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20</code></pre>
</div>
</div>
<p>Again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f2c</span>(<span class="dv">32</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>And again, this time on a vector of values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">f2c</span>(<span class="fu">c</span>(<span class="dv">14</span>,<span class="dv">50</span>,<span class="dv">212</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -10  10 100</code></pre>
</div>
</div>
<p>In this last case, we can see that, as built, our function can handle not only single values, but multiple values given as a vector. This is pretty good, but it only goes one way. What would be more useful would be a function that could do conversions in both directions. To do this, we can modify our function by adding a second variable to indicate whether we are converting from Fahrenheit or Celsius, and if/else statement that changes the maths accordingly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>convertTemp<span class="ot">&lt;-</span><span class="cf">function</span>(t,s){</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">"F"</span>){</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    converted<span class="ot">&lt;-</span>((t<span class="sc">+</span><span class="dv">40</span>)<span class="sc">/</span><span class="fl">1.8</span>)<span class="sc">-</span><span class="dv">40</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    converted<span class="ot">&lt;-</span>((t<span class="sc">+</span><span class="dv">40</span>)<span class="sc">*</span><span class="fl">1.8</span>)<span class="sc">-</span><span class="dv">40</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  converted</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we’ve used a second argument, s, to indicate a symbol. If that symbol’s value is “F”, it will run the first value, t, through the formula for Fahrenheit to Celcius. In any other case, it will run the value through formula for Celcius to Fahrenheit. Now instead of accepting only Fahrenheit temperatures, we can convert from either Fahrenheit or Celsius.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="dv">40</span>,<span class="st">"C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 104</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="dv">40</span>,<span class="st">"F"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.444444</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="fu">c</span>(<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>),<span class="st">"C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  68  86 104</code></pre>
</div>
</div>
<p>This seems pretty good, and once again we can apply the conversion to a vector of values, but there’s something we’re missing. Since we used <code>else</code> in this case, we could literally type in anything other than “F” and get the Celsius value. Behold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="st">"Bobcar"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -58</code></pre>
</div>
</div>
<p>There are a couple of things we can do at this point to make our function a bit more… functional. First, we can take the <code>else</code> out of our if/else statement and convert it into two if statements that either use “C” or “F” for scales. Second, we can add in a warning in the event that the scale is neither of these. Try editing the function in the following way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>convertTemp<span class="ot">&lt;-</span><span class="cf">function</span>(t,s){</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">"F"</span>){</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    converted<span class="ot">&lt;-</span>((t<span class="sc">+</span><span class="dv">40</span>)<span class="sc">/</span><span class="fl">1.8</span>)<span class="sc">-</span><span class="dv">40</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">"C"</span>) {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    converted<span class="ot">&lt;-</span>((t<span class="sc">+</span><span class="dv">40</span>)<span class="sc">*</span><span class="fl">1.8</span>)<span class="sc">-</span><span class="dv">40</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(s <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"C"</span>,<span class="st">"F"</span>))) {</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Scale invalid. Please use C or F for scale."</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    converted</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we’ve used two <code>if</code> statements to convert the temperatures, and an if/else statement to determine if a valid scale has been entered. To determine if we have an invalid scale value, we use another <code>if</code> statement, but this one is a little funny. The <code>!</code> symbol means “not” in most programming languages, while s %in% c(“C”,“F”) means “s is a member of a set containing C and F”. Put it all together and it reads</p>
<p><strong>“If it is not the case that s is a member of a set containing C and F, then…”</strong></p>
<p>This provides the condition that triggers our warning. Now if we enter an invalid scale, we get a helpful warning, and otherwise we get the correct value:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="st">"C"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -58</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">convertTemp</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="st">"Bobcar"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in convertTemp(-50, "Bobcar"): Scale invalid. Please use C or F for
scale.</code></pre>
</div>
</div>
<p>In programming terms, this is an example of <em>exception handling</em>, where we have accounted for potential misuses of the function within the code itself. However, not all possible errors are accounted for in our function. Someone with the inclination might try to use a character string, or a boolean TRUE/FALSE. These will inevitably lead to problems, some of which may or may not have clear solutions for the user. How much care you put into error handling will be a major factor in the reusability of your code for other purposes.</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>PG Jellyman, DJ Booker, SK Crow, ML Bonnett &amp; DJ Jellyman (2013) Does one size t all? An evaluation of lengthweight relationships for New Zealand’s freshwater sh species, New Zealand Journal of Marine and Freshwater Research, 47:4, 450-468<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>